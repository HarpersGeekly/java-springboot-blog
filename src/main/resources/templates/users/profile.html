<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:include="fragments/header :: my-header('Profile')">
    <style>

        .page {
            margin: 1em auto;
            max-width: 768px;
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
            height: 100%;
        }

        .box {
            padding: 0.5em;
            width: 100%;
            margin:0.5em;
        }

        .box-2 {
            padding: 0.5em;
            width: calc(100%/2 - 1em);
        }

        .options label,
        .options input{
            width:4em;
            padding:0.5em 1em;
        }
        .btn{
            background:white;
            color:black;
            border:1px solid black;
            padding: 0.5em 1em;
            text-decoration:none;
            margin:0.8em 0.3em;
            display:inline-block;
            cursor:pointer;
        }

        .hide {
            display: none;
        }

        img {
            max-width: 100%;
        }

    </style>
</head>
<body>
<nav th:include="fragments/navbar :: my-navbar"></nav>

<!-- Show different words or features based on whether you're on your profile or someone else's -->

<div class="container" id="profilePageWrapper">

<!--============================================ VIEWING LOGGED IN USERS PROFILE ========================================-->
<!--Reminder: #authentication.principal is the currently logged-in/session user-->

    <th:block sec:authorize="isAuthenticated()" th:if="${isOwnProfile}">

        <h2>Welcome, <span th:text="${#authentication.principal.username}"></span>!</h2>

        <div class="cropper-container">
            <!-- Modal -->
            <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" id="modal-header">
                            <h5 class="modal-title" id="modalLabel"></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="page">
                                <form th:action="@{'/profile/edit/fileupload'}" method="POST" enctype="multipart/form-data"
                                      id="data-edit-profile-picture-form">
                                    <input type="hidden" th:attr="name=${_csrf.parameterName},value=${_csrf.token}"/>
                                <!-- input file -->
                                    <div class="box" id="modalUploadPicBtnBox">
                                        <label for="file-input" class="custom-file-upload btn btn-secondary">
                                            <i class="fas fa-upload" style="padding-right: 1em"></i>Upload Profile Picture
                                            <input id="file-input" name="file" type="file" style="display:none;"/>
                                        </label>
                                    </div>
                                <!-- leftbox -->
                                    <div class="box-2">
                                        <div class="result"></div>
                                    </div>
                                    <!--rightbox-->
                                    <div class="box-2 img-result hide">

                                        <!-- result of crop -->
                                        <img name="croppedImage" class="cropped" src="" alt=""/>


                                    </div>
                                    <!-- input file -->
                                    <div class="box">
                                        <div class="options hide">
                                            <!--<label> Width</label>-->
                                            <!--<input type="number" class="img-w" value="300" min="100" max="1200" />-->
                                        </div>
                                        <!-- save btn -->
                                        <button class="btn save hide">Save</button>
                                        <!-- download btn -->
                                        <a href="" class="btn download hide">Download</a>
                                        <!--confirm selection-->
                                        <button type="button" class="btn confirm hide" data-dismiss="modal">Confirm Selection</button>
                                        <div th:if="${fileFailure}" class="alert alert-success fade in">
                                            <strong th:text="${message}"></strong>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                        <div class="modal-footer" id="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="profile-upper-wrapper">
            <div class="profile-picture-wrapper">
                <span th:if="${#authentication.principal.profilePicture} == null">
                    <img class="profilePic" src="/../images/user.png" width="150px" height="150px"/>
                </span>
                <span th:if="${#authentication.principal.profilePicture} != null">
                    <img class="profilePic" th:src="@{'/uploads/' + ${#authentication.principal.profilePicture}}" width="150px" height="150px"/>
                </span>
            </div>

            <div class="profile-info-wrapper">
                <h3>You are logged in. You can make comments and <a id="profileCreatePostLink" th:href="${'/posts/create'}">create a post.</a></h3>
                <h4>
                    <i class="far fa-envelope profileEmailIcon"></i>
                        <span th:text="${#authentication.principal.email}"/>
                </h4>

                <h4>
                    <i class="far fa-handshake profileJoinIcon"></i>
                    <span th:text="${#temporals.monthNameShort(#authentication.principal.date)}"></span>
                    <span th:text="${#temporals.day(#authentication.principal.date)}"></span>,
                    <span th:text="${#temporals.year(#authentication.principal.date)}"></span>
                </h4>

                <div class="profileChangeUsernameDiv">
                    <i class="fas fa-cog profileCogIcon"></i>
                    <a th:href="@{/profile/{id}/edit(id=${#authentication.principal.id})}">
                        <h5 id="profileChangeUsernameLink">edit account</h5>
                    </a>
                </div>
                <div class="profileChangePasswordDiv">
                    <i class="fas fa-lock-open profilePasswordIcon"></i>
                    <a th:href="@{/profile/{id}/editPassword(id=${#authentication.principal.id})}">
                        <h5 id="profileChangePasswordLink">change password</h5>
                    </a>
                </div>
                <label id="profileChangePictureLink" data-target="#modal" data-toggle="modal">
                    <i class="fas fa-upload uploadIcon"></i>change profile picture
                </label>
                <!-- Button trigger modal -->
                <!--<input id="file" onchange="previewFile()" name="file" type="file" style="display:none;"/>-->

            </div>
        </div>

    <hr class="commentHR"/>

        <h4>Your posts:</h4>
        <h5 th:if="${postsAreEmpty}">
            <i class="far fa-frown profileFrownIcon"></i> You don't have any posts yet... get posting!
        </h5>
    </th:block>

<!--============================================== VIEWING OTHER USERS PROFILES ===========================================-->

    <th:block th:if="${!isOwnProfile}">
        <h2><span th:text="${profileUser.username}"></span>'s profile!</h2>

        <div class="profile-upper-wrapper">
            <div class="profile-picture-wrapper">
                <span th:if="${profileUser.profilePicture} == null">
                        <img class="profilePic" src="/../images/user.png" width="150px" height="150px"/>
                </span>
                <span th:if="${profileUser.profilePicture} != null">
                        <img id="profilePic" th:src="@{'/uploads/' + ${profileUser.profilePicture}}" width="150px" height="150px"/>
                </span>
            </div>

            <div class="profile-info-wrapper">
                <h4>
                    <i class="far fa-envelope profileEmailIcon"></i>
                        <span th:text="${profileUser.email}"></span>
                </h4>
                <h4>
                    <i class="far fa-handshake profileJoinIcon"></i>
                        <span th:text="${#temporals.monthNameShort(profileUser.date)}"></span>
                        <span th:text="${#temporals.day(profileUser.date)}"></span>,
                        <span th:text="${#temporals.year(profileUser.date)}"></span>
                </h4>
            </div>
        </div>

    <hr class="commentHR"/>

        <h4>Their posts:</h4>
        <h5 th:if="${postsAreEmpty}">
            <i class="far fa-frown profileFrownIcon"></i> They don't have any posts yet... lame!
        </h5>
    </th:block>

<!--============================================== THE LIST OF POSTS ======================================================-->

    <div id="profileContent" th:each="post : ${profileUser.posts}">
        <ul>
            <li>
                <div class="profilePostVoteTitleRow">

                    <div class="profilePostVoteCountDiv">
                        <h5 class="profilePostVoteCountText" th:text="${post.voteCount()}"></h5>
                    </div>

                    <div class="profilePostThumbsUpDiv">
                        <i class="fas fa-thumbs-up profilePostVoteIcon"></i>
                    </div>

                    <div class="profilePostCommentCountDiv">
                        <h5 class="profilePostCommentCountText" th:text="${post.getComments().size()}"></h5>
                    </div>

                    <div class="profilePostCommentIconDiv">
                        <i class="fas fa-comments profilePostCommentIcon"></i>
                    </div>

                    <div class="profilePostTitleDiv">
                        <a th:href="@{/posts/{id}(id=${post.id})}"><h4 class="profilePostTitleText" th:text="${post.title}"></h4></a>
                    </div>

                </div>
                <!--=====markdown parsing:===============-->
                <div class="postTextBodyDiv">
                    <h5 th:utext="${post.htmlDescription}"></h5>
                </div>
                <!--=====================================-->
                <h5 id="createdDate"><strong>created on:
                    <span th:text="${#temporals.monthNameShort(post.date)}"></span>
                    <span th:text="${#temporals.day(post.date)}"></span>,
                    <span th:text="${#temporals.year(post.date)}"></span> at
                    <span th:text="${#temporals.format(post.date,  'h:mm a')}"></span></strong></h5>

                <div th:if="${isOwnProfile}">
                    <div class="container">

                        <div class="row">
                            <div class="col-sm">
                                <a class="btn btn-primary" id="profileEditPostBtn" th:href="${'/posts/' + post.id + '/edit'}">
                                    <i class="far fa-edit"></i> Edit
                                </a>

                            <!--=================================== DELETE BUTTON =========================================-->
                                <form th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post"> <!--th:object="${post}"-->
                                    <!--<input type="hidden" name="id" th:field="*{id}" />-->
                                    <button type="submit" class="btn btn-primary btn-danger" id="profileDeletePostBtn">
                                        <i class="fas fa-bomb"></i> Delete
                                    </button>
                                    <!-- <input th:if="${isEditable}"-->
                                </form>
                            </div>
                        </div>

                    </div>
                </div>

            </li>
        </ul>
    </div>
</div>
<footer th:include="fragments/footer :: my-footer"></footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/0.8.1/cropper.min.js"></script>
<script src="/js/image-cropper.js">
</script>
</body>
</html>

