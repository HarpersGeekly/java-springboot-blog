<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:include="fragments/header :: my-header('Show Post')">
</head>
<body>
<nav th:include="fragments/navbar :: my-navbar"></nav>

<div id="showPageWrapper">

<!-- ====================================================  SHOW THE POST ============================================-->
    <div class="container">

        <fieldset>
            <legend>
                <h4 th:text="${post.title}" id="showPageIntro"></h4>
            </legend>

            <!--<div class="row commentVoting">-->

                <!--&lt;!&ndash;if not logged in: upvote and downvote arrows are href's linked to the login page. &ndash;&gt;-->
                <!--<div th:if="${!isLoggedIn}"><a th:href="${'/login'}"><span-->
                        <!--class="glyphicon glyphicon-chevron-up"></span></a></div>-->
                <!--&lt;!&ndash;if logged in: upvote and downvote arrows function normally.&ndash;&gt;-->
                <!--<div th:if="${isLoggedIn}"><span class="glyphicon glyphicon-chevron-up upvote"></span></div>-->

                <!--<div><h5><span id="voteCount" th:text="${post.voteCount}"></span></h5></div>-->

                <!--<div th:if="${isLoggedIn}"><span class="glyphicon glyphicon-chevron-down"></span></div>-->
                <!--<div th:if="${!isLoggedIn}"><a th:href="${'/login'}"><span class="glyphicon glyphicon-chevron-down downvote"></span></a></div>-->

            <!--</div>-->

        <h5 class="postedBy">
            <a th:href="${'/profile/' + post.user.id}">
                <span th:text="${post.user.username}"></span>
            </a> |
        <!--<h5 id="createdDate">created: <span th:text="${#temporals.format(post.date, 'MM-dd-yyyy, h:mm a')}"></span></h5>-->
            <span th:text="${#temporals.format(post.date,  'h:mm a')}"></span> |
            <span th:text="${#temporals.monthNameShort(post.date)}"></span>
            <span th:text="${#temporals.day(post.date)}"></span>,
            <span th:text="${#temporals.year(post.date)}"></span>
        </h5>

        <h5 th:text="${post.description}"></h5>

        <div sec:authorize="isAuthenticated()">
            <div th:if="${isPostOwner}">
                <div class="container">

                    <div class="row">
                        <div class="col-sm">
                            <a class="btn btn-primary" id="editPostBtn" th:href="${'/posts/' + post.id + '/edit'}">
                                <i class="far fa-edit"></i> Edit
                            </a>

                            <!--=================================== DELETE BUTTON =========================================-->
                            <form th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post"> <!--th:object="${post}"-->
                                <!--<input type="hidden" name="id" th:field="*{id}" />-->
                                <button type="submit" class="btn btn-primary btn-danger" id="deletePostBtn">
                                    <i class="fas fa-bomb"></i> Delete
                                </button>
                                <!-- <input th:if="${isEditable}"-->
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>


<!--================================================= SHOW THE POST COMMENT FORM ====================================-->
        <div sec:authorize="isAuthenticated()">

            <form th:action="${'/posts/' + post.id}" method="post" th:object="${comment}">
                <div class="form-group">
                    <label for="commentFormBody"></label>
                    <textarea class="form-control" id="commentFormBody" name="body"
                              th:field="*{body}"
                              th:placeholder="Comment..."
                              style="width: 900px; height: 150px; resize: none">
                        </textarea>

                    <div
                            th:if="${#fields.hasErrors('body')}"
                            class="alert alert-danger alert-dismissible"
                            role="alert">
                        <span th:errors="*{body}"/>
                    </div>

                    <input class="form-control" type="hidden" name="id" th:field="*{id}"/>
                    <button class="btn btn-primary">
                        <i class="far fa-comment-alt"></i> Comment
                    </button>

                </div>
            </form>
        </div>
        </fieldset>
    </div>

<!--============================================= SHOW ALL COMMENTS (PAGEABLE) ======================================-->

    <hr id="commentHRLeader"/>

    <div class="container" id="commentSection" th:each="comment : ${page}">

        <div class="row commentVoting">

            <!--if not logged in: upvote and downvote arrows are href's linked to the login page. -->
            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="far fa-thumbs-up"></i>
                </a>
            </div>
            <!--if logged in: upvote and downvote arrows function normally.-->
            <div th:if="${isLoggedIn}">
                <i class="far fa-thumbs-up upvote"></i>
            </div>

            <div>
                <h5>
                    <span id="voteCount" th:text="${comment.voteCount}"></span>
                </h5>
            </div>

            <div th:if="${isLoggedIn}">
                <i class="far fa-thumbs-down"></i>
            </div>
            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="far fa-thumbs-down downvote"></i>
                </a>
            </div>

        </div>

        <div class="row commentBody">
            <h5 class="postedBy">
                <a th:href="${'/profile/' + comment.user.id}">
                    <span th:text="${comment.user.username}"></span>
                </a> |
            <!--</h5>-->

            <!--<h5 class="createdCommentDate">-->
                <span th:text="${#temporals.format(comment.date,  'h:mm a')}"></span> |
                <span th:text="${#temporals.monthNameShort(comment.date)}"></span>
                <span th:text="${#temporals.day(comment.date)}"></span>,
                <span th:text="${#temporals.year(comment.date)}"></span>
            </h5>

            <h5 th:text="${comment.body}" id="commentBody"></h5>

        </div>
                                     <!--================================== REPLY TO A COMMENT ======================-->

            <h5 class="showReplyTextArea" sec:authorize="isAuthenticated()">REPLY</h5>
            <div class="replyTextArea">
                <!--<form th:action="${'/posts/' + post.id}" method="post" th:object="${comment}">-->
                <form th:action="${'/posts/' + post.id + '/comment/' + comment.id}" method="post" th:object="${reply}">
                    <div class="form-group">
                        <label for="replyFormBody"></label>
                        <textarea class="form-control" id="replyFormBody" name="body"
                                  th:field="*{body}"
                                  th:placeholder="Comment..."
                                  style="width: 900px; height: 150px; resize: none">
                            </textarea>

                        <div th:if="${#fields.hasErrors('body')}"
                             class="alert alert-danger alert-dismissible"
                             role="alert">
                            <span th:errors="*{body}"/>
                        </div>
                        <input class="form-control" type="hidden" name="id" th:field="*{id}"/>
                        <button class="btn btn-primary">
                            <i class="far fa-comment-alt"></i> Reply
                        </button>

                    </div>
                </form>
            </div>

                                    <!--==================================== DELETE A COMMENT =======================-->
        <div class="commentDelete" sec:authorize="isAuthenticated()">

            <form th:if="${comment.isOwnedBy(#authentication.principal.id)}"
                  th:action="${'/posts/' + post.id + '/comment/' + comment.id + '/delete'}" method="POST"
                  th:object="${comment}">

                <input type="hidden" name="id" th:value="${comment.id}"/>
                <i class="fas fa-bomb"></i>
                <input type="submit" value="Delete" class="btn btn-primary deleteCommentBtn"/>

            </form>
        </div>

                                    <!--===================================== EDIT A COMMENT ========================-->
        <div class="commentEdit" sec:authorize="isAuthenticated()" th:if="${comment.isOwnedBy(#authentication.principal.id)}">

            <i class="far fa-edit"></i>
                <button class="btn btn-primary editCommentBtn"
                        th:href="${'/posts/' + post.id + '/comment/' + comment.id + '/edit'}"> Edit
                </button>

            <!--<form th:if="${comment.isOwnedBy(#authentication.principal.id)}"-->
                  <!--th:action="${'/posts/' + post.id + '/comment/' + comment.id + '/edit'}" method="POST"-->
                  <!--th:object="${comment}">-->

                <!--<input type="hidden" name="id" th:value="${comment.id}"/>-->
                    <!--<input type="submit" value="Edit" class="btn btn-primary btn-warning editCommentBtn"/>-->
            <!--</form>-->
        </div>






        <hr class="commentHR"/>

<!-- ================================================================================================================-->
            <!-- =======================  REPLIES TO COMMENTS ON A POST ========================-->

        <div style="margin-left: 50px" id="replies" th:each="reply: ${comment.replies}">

            <!--<h5>SHOW REPLIES HERE</h5>-->

            <div class="row commentVoting">

                <!--if not logged in: upvote and downvote arrows are href's linked to the login page. -->
                <div th:if="${!isLoggedIn}">
                    <a th:href="${'/login'}">
                        <i class="far fa-thumbs-up"></i>
                    </a>
                </div>
                <!--if logged in: upvote and downvote arrows function normally.-->
                <div th:if="${isLoggedIn}">
                    <i class="far fa-thumbs-up upvote"></i>
                </div>

                <div>
                    <h5>
                        <span id="voteCount" th:text="${reply.voteCount}"></span>
                    </h5>
                </div>

                <div th:if="${isLoggedIn}">
                    <i class="far fa-thumbs-down"></i>
                </div>

                <div th:if="${!isLoggedIn}">
                    <a th:href="${'/login'}">
                        <i class="far fa-thumbs-down downvote"></i>
                    </a>
                </div>

            </div>

            <div class="row commentBody">
                <h5 class="postedBy">posted by:
                    <a th:href="${'/profile/' + reply.user.id}">
                        <span th:text="${reply.user.username}"></span>
                    </a> |

                    <span th:text="${#temporals.format(reply.date,  'h:mm a')}"></span> |
                    <span th:text="${#temporals.monthNameShort(reply.date)}"></span>
                    <span th:text="${#temporals.day(reply.date)}"></span>,
                    <span th:text="${#temporals.year(reply.date)}"></span>
                </h5>

                <h5 th:text="${reply.body}"></h5>

            </div>

                                       <!--==================================== DELETE A REPLY ======================-->
            <div class="commentDelete" sec:authorize="isAuthenticated()">

                <form id="deleteForm" th:if="${reply.isOwnedBy(#authentication.principal.id)}"
                      th:action="${'/posts/' + post.id + '/comment/' + comment.id + '/reply/' + reply.id + '/delete'}" method="POST"
                      th:object="${reply}">

                    <input type="hidden" name="id" th:value="${reply.id}"/>
                    <input type="submit" value="delete" class="btn btn-primary btn-danger deleteCommentBtn"/>
                </form>
            </div>


                                        <!--===================================== EDIT A REPLY ======================-->

            <hr class="commentHR"/>

        </div> <!-- END OF THE LOOP:  th:each="reply : ${replies}" -->
    </div> <!-- END OF THE LOOP:  th:each="comment : ${page}" -->


    <!--<!=================================== PAGINATION =========================================================-->
    <nav class="text-center">
        <ul class="pagination">

            <li th:class="${page.isFirst()}? 'disabled' : ''">
                <span th:if='${page.isFirst()}'>← First</span>
                <a th:if='${not page.isFirst()}' th:href="'?page=0'">
                    ← First
                </a>
            </li>
            <li th:class="${page.hasPrevious()}? '' : 'disabled'">
                <span th:if='${not page.hasPrevious()}'>«</span>
                <a
                        th:if='${page.hasPrevious()}'
                        th:href="'?page=' + ${page.getNumber() - 1}"
                        title='Go to previous page'
                >
                    «
                </a>
            </li>
            <!--<li th:each="i : ${#numbers.sequence(1, page.getTotalPages())}">-->
            <li th:each="i : ${#numbers.sequence(page.getNumber(), page.getTotalPages())}">
                <span
                        th:if='${(i - 1) == param.page}'
                        th:text='${i}'>
                    1
                </span>
                <a
                        th:if='${not ((i - 1) == param.page)}'
                        th:href="'?page=' + ${(i -1)}"
                >
                    <span th:text='${i}'>1</span>
                </a>
            </li>
            <li th:class="${page.hasNext()} ? '' : 'disabled'">
                <span th:if='${not page.hasNext()}'>»</span>
                <a
                        th:if='${page.hasNext()}'
                        th:href="'?page=' + ${page.getNumber() + 1}"
                        title='Go to next page'
                >
                    »
                </a>
            </li>
            <li th:class="${page.isLast()}? 'disabled' : ''">
                <span th:if='${page.isLast()}'>Last →</span>
                <a
                        th:if='${not page.isLast()}'
                        th:href="'?page=' + ${page.getTotalPages() - 1}"
                >
                    Last →
                </a>
            </li>
        </ul>
    </nav>

</div>
<footer th:include="fragments/footer :: my-footer"></footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>

    $(document).ready(function () {

        $(".replyTextArea").hide();

        $(".showReplyTextArea").on('click', function () {
            $(this).text(function (_, oldText) {
                return oldText === 'CANCEL' ? 'REPLY' : 'CANCEL';
            });
            $(this).next().toggle(500);
        });

        $("form").submit(function () {
            $(".replyTextArea").hide();
        });

//        $("#replies").hover(
//            function() {
//                $(this).children.children(".").removeClass("hidden");
//            },
//            function () {
//                $(this).children("#deleteForm").addClass("hidden");
//            });
    })

</script>
</body>
</html>