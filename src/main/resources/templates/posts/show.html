<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:include="fragments/header :: my-header('Show Post')">
</head>
<body>
<nav th:include="fragments/navbar :: my-navbar"></nav>

<div id="showPageWrapper">
    <!-- ================================================================================================================-->
    <!-- ====================================================  SHOW THE POST ============================================-->
    <!-- ================================================================================================================-->
    <div class="container">

        <h4 th:text="${post.title}" id="showPageIntro"></h4>

        <!-- ========================================= Post Voting ====================================-->

        <div class="row commentVoting">

            <!--if not logged in: upvote and downvote arrows are href's linked to the login page. -->
            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="far fa-thumbs-up upvote"></i>
                </a>
            </div>
            <!--if logged in: upvote and downvote arrows function normally.-->
            <div th:if="${isLoggedIn}">
                <i class="far fa-thumbs-up upvote"></i>
            </div>

            <div>
                <h5>
                    <!--<span class="voteCount" th:text="${post.voteCount}"></span>--> 0
                </h5>
            </div>

            <div th:if="${isLoggedIn}">
                <i class="far fa-thumbs-down downvote"></i>
            </div>

            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="far fa-thumbs-down downvote"></i>
                </a>
            </div>

        </div>

        <!-- ====================================== Post User and Time  ============================== -->

        <h5 class="postedBy">
            <a th:href="${'/profile/' + post.user.id}">
                <span th:text="${post.user.username}"></span>
            </a> |
            <!--<h5 id="createdDate">created: <span th:text="${#temporals.format(post.date, 'MM-dd-yyyy, h:mm a')}"></span></h5>-->
            <span th:text="${#temporals.format(post.date,  'h:mm a')}"></span> |
            <span th:text="${#temporals.monthNameShort(post.date)}"></span>
            <span th:text="${#temporals.day(post.date)}"></span>,
            <span th:text="${#temporals.year(post.date)}"></span>
        </h5>

        <!-- ====================================== Post Description =================================-->

        <h5 th:text="${post.description}"></h5>

        <!-- ====================================== Post Edit and Delete Buttons =====================-->

        <div sec:authorize="isAuthenticated()">
            <div th:if="${isPostOwner}">
                <div class="container">
                    <div class="row">
                        <div class="col-sm">
                            <a id="editPostBtn" th:href="${'/posts/' + post.id + '/edit'}">
                                <i class="far fa-edit"></i> edit
                            </a>

                            <!--========================== Post Delete Button ================-->

                            <form th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post">
                                <!--th:object="${post}"-->
                                <!--<input type="hidden" name="id" th:field="*{id}" />-->
                                <button type="submit" id="deletePostBtn">
                                    <i class="fas fa-bomb"></i> delete
                                </button>

                                <!-- <input th:if="${isEditable}"-->
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================================================================-->
        <!--============================================== FORM for COMMENTS ================================================-->
        <!-- ================================================================================================================-->

        <div th:if="${!isLoggedIn}">
            <a th:href="${'/login'}"> REPLY
            </a>
        </div>

        <div sec:authorize="isAuthenticated()">

            <form th:action="${'/posts/' + post.id}" method="post" th:object="${comment}" class="commentForm">
                <div class="form-group">
                    <label for="commentFormBody"></label>
                    <textarea class="form-control" id="commentFormBody" name="body"
                              th:field="*{body}"
                              th:placeholder="Comment..."
                              style="width: 900px; height: 150px; resize: none">
                            </textarea>

                    <div
                            th:if="${#fields.hasErrors('body')}"
                            class="alert alert-danger alert-dismissible"
                            role="alert">
                        <span th:errors="*{body}"/>
                    </div>

                    <!-- ======================== submit comment ================================-->

                    <input class="form-control" type="hidden" id="postId" th:value="${post.id}"/>
                    <button class="btn btn-primary commentSubmitBtn">
                        <i class="far fa-comment-alt"></i> Comment
                    </button>

                </div>
            </form>
        </div>
    </div>

    <!-- ================================================================================================================-->
    <!--============================================= SHOW ALL COMMENTS (PAGEABLE) ======================================-->
    <!-- ================================================================================================================-->

    <hr id="commentHRLeader"/>

    <div class="container commentSection" th:each="comment : ${page}" th:data="*{page}">

        <!-- =============================== Comment Votes =========================-->

        <div id="commentsAJAX"></div> <!-- This div will prepend with new ajax html. It should not be targeted otherwise -->

        <div class="comment-wrapper" th:attr="data-edit-delete-comment-id=${comment.id}"> <!-- this div should be targeted with unique th:attr -->

            <div class="row commentVoting">

                <!--if not logged in: upvote and downvote arrows are href's linked to the login page. -->
                <div th:if="${!isLoggedIn}">
                    <a th:href="${'/login'}">
                        <i class="far fa-thumbs-up upvote"></i>
                    </a>
                </div>
                <!--if logged in: upvote and downvote arrows function normally.-->
                <div th:if="${isLoggedIn}">
                    <i class="far fa-thumbs-up upvote"></i>
                </div>

                <div>
                    <h5>
                        <span class="voteCount" th:text="${comment.voteCount}"></span>
                    </h5>
                </div>

                <div th:if="${isLoggedIn}">
                    <i class="far fa-thumbs-down downvote"></i>
                </div>
                <div th:if="${!isLoggedIn}">
                    <a th:href="${'/login'}">
                        <i class="far fa-thumbs-down downvote"></i>
                    </a>
                </div>

            </div>

            <div class="row">
                <h5 class="postedBy">
                    <a th:href="${'/profile/' + comment.user.id}">
                        <span th:text="${comment.user.username}"></span>
                    </a> |
                    <!--</h5>-->

                    <!--<h5 class="createdCommentDate">-->
                    <span th:text="${#temporals.format(comment.date,  'h:mm a')}"></span> |
                    <span th:text="${#temporals.monthNameShort(comment.date)}"></span>
                    <span th:text="${#temporals.day(comment.date)}"></span>,
                    <span th:text="${#temporals.year(comment.date)}"></span>
                </h5>

                <!-- =============================== Comment Body =========================-->

                <h5 th:text="${comment.body}" id="commentBodyText" th:attr="data-commentBody-comment-id=${comment.id}"></h5>

                <!-- =============================== Edit Form ============================-->

                <form
                      th:action="@{/posts/{postId}/comment/{commentId}/edit(postId=${post.id},commentId=${comment.id})}"
                      method="POST"
                      th:object="${comment}"
                      class="editedCommentForm" id="editedCommentFormId" th:attr="data-edit-form-comment-id=${comment.id}">

                    <textarea class="form-control editedCommentBodyText" name="body"
                              th:value="${comment.body}"
                              style="width: 900px; height: 150px; resize: none">
                    </textarea>

                    <input type="hidden" name="id" th:data-edit-form-comment-id="${comment.id}" th:value="${comment.id}"/>

                    <button class="editedCommentSubmitBtn">
                        submit
                    </button>

                    <button class="editedCommentCancelBtn">
                        cancel
                    </button>
                </form>

            </div>

            <!--================================== REPLY TO A COMMENT ======================-->
            <!--============================================================================-->

            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="fas fa-reply"></i> REPLY
                </a>
            </div>
            <div th:if="${isLoggedIn}">
                <h5 class="showReplyTextArea" sec:authorize="isAuthenticated()" th:attr="data-replyButton-comment-id=${comment.id}">
                <i class="fas fa-reply"></i> REPLY
                </h5>

                <div class="replyTextArea">
                    <form th:action="${'/posts/' + post.id + '/comment/' + comment.id}" method="post"
                          th:object="${reply}">
                        <div class="form-group">
                            <label for="replyFormBody"></label>
                            <textarea class="form-control" id="replyFormBody" name="body"
                                      th:field="*{body}"
                                      th:placeholder="Comment..."
                                      style="width: 900px; height: 75px; resize: none">
                                </textarea>

                            <div th:if="${#fields.hasErrors('body')}"
                                 class="alert alert-danger alert-dismissible"
                                 role="alert">
                                <span th:errors="*{body}"/>
                            </div>
                            <input class="form-control" type="hidden" name="id" th:field="*{id}"/>
                            <button class="btn btn-primary">
                                <i class="far fa-comment-alt"></i> Reply
                            </button>

                        </div>
                    </form>
                </div>
            </div>

            <!--===================================== EDIT COMMENT BUTTON ========================-->
            <!--==================================================================================-->
            <div class="editAndDeleteWrapper">
                <div class="row">

                    <!-- Edit button is an event trigger. There is no form here. -->
                    <div class="commentEdit" sec:authorize="isAuthenticated()"
                         th:if="${comment.isOwnedBy(#authentication.principal.id)}">
                        <a class="editCommentBtn" th:attr="data-edit-btn-comment-id=${comment.id}">
                            <i class="far fa-edit"></i> edit
                        </a>
                    </div>

                    <!--==================================== DELETE COMMENT BUTTON AND FORM =======================-->
                    <!--===========================================================================================-->

                    <div class="commentDelete" sec:authorize="isAuthenticated()">
                        <form th:if="${comment.isOwnedBy(#authentication.principal.id)}"
                              th:action="@{/posts/{postId}/comment/{commentId}/delete(postId=${post.id}, commentId=${comment.id})}"
                              method="POST"
                              th:object="${comment}"
                              class="deleteCommentForm">

                            <input type="hidden" name="id" th:attr="data-comment-id=${comment.id}" th:value="${comment.id}"/>
                            <!--<input type="hidden" name="id" id="deleteCommentBtn" th:value="${comment.id}"/>-->
                            <button class="deleteCommentBtn">
                                <i class="fas fa-bomb"></i> delete
                            </button>
                            <!--<i class="fas fa-bomb"></i>-->
                            <!--<input type="submit" value="delete" class="deleteCommentBtn"/>-->
                        </form>
                    </div>

                </div>
            </div>

            <hr class="commentHR"/>
        </div>
    </div>

    <!-- ================================================================================================================-->
    <!-- =======================  REPLIES TO COMMENTS ON A POST ========================-->
    <!-- ================================================================================================================-->

    <div style="margin-left: 50px" id="replies" th:each="reply: ${comment.replies}">

        <!--<h5>SHOW REPLIES HERE</h5>-->

        <div class="row commentVoting">

            <!--if not logged in: upvote and downvote arrows are href's linked to the login page. -->
            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="far fa-thumbs-up upvote"></i>
                </a>
            </div>
            <!--if logged in: upvote and downvote arrows function normally.-->
            <div th:if="${isLoggedIn}">
                <i class="far fa-thumbs-up upvote"></i>
            </div>

            <div>
                <h5>
                    <span class="voteCount" th:text="${reply.voteCount}"></span>
                </h5>
            </div>

            <div th:if="${isLoggedIn}">
                <i class="far fa-thumbs-down downvote"></i>
            </div>

            <div th:if="${!isLoggedIn}">
                <a th:href="${'/login'}">
                    <i class="far fa-thumbs-down downvote"></i>
                </a>
            </div>

        </div>

        <div class="row replyBody">
            <h5 class="postedBy">
                <a th:href="${'/profile/' + reply.user.id}">
                    <span th:text="${reply.user.username}"></span>
                </a> |

                <span th:text="${#temporals.format(reply.date,  'h:mm a')}"></span> |
                <span th:text="${#temporals.monthNameShort(reply.date)}"></span>
                <span th:text="${#temporals.day(reply.date)}"></span>,
                <span th:text="${#temporals.year(reply.date)}"></span>
            </h5>

            <h5 th:text="${reply.body}"></h5>

        </div>

        <!--==================================== DELETE A REPLY ======================-->
        <div class="commentDelete" sec:authorize="isAuthenticated()">

            <form id="deleteForm" th:if="${reply.isOwnedBy(#authentication.principal.id)}"
                  th:action="${'/posts/' + post.id + '/comment/' + comment.id + '/reply/' + reply.id + '/delete'}"
                  method="POST"
                  th:object="${reply}">

                <input type="hidden" name="id" th:value="${reply.id}"/>
                <!--<input type="submit" value="delete" class="deleteCommentBtn"/>-->
                <button type="submit" class="deleteCommentBtn">
                    <i class="fas fa-bomb"></i> delete
                </button>
            </form>
        </div>

        <!--===================================== EDIT A REPLY ======================-->

        <hr class="commentHR"/>

    </div> <!-- END OF THE LOOP:  th:each="reply : ${replies}" -->
</div> <!-- END OF THE LOOP:  th:each="comment : ${page}" -->


<!-- ================================================================================================================-->
<!-- =========================================== PAGINATION =========================================================-->
<!-- ================================================================================================================-->
<nav class="text-center">
    <ul class="pagination">

        <li th:class="${page.isFirst()}? 'disabled' : ''">
            <span th:if='${page.isFirst()}'>← First</span>
            <a th:if='${not page.isFirst()}' th:href="'?page=0'">
                ← First
            </a>
        </li>
        <li th:class="${page.hasPrevious()}? '' : 'disabled'">
            <span th:if='${not page.hasPrevious()}'>«</span>
            <a
                    th:if='${page.hasPrevious()}'
                    th:href="'?page=' + ${page.getNumber() - 1}"
                    title='Go to previous page'
            >
                «
            </a>
        </li>
        <!--<li th:each="i : ${#numbers.sequence(1, page.getTotalPages())}">-->
        <li th:each="i : ${#numbers.sequence(page.getNumber(), page.getTotalPages())}">
                <span
                        th:if='${(i - 1) == param.page}'
                        th:text='${i}'>
                    1
                </span>
            <a
                    th:if='${not ((i - 1) == param.page)}'
                    th:href="'?page=' + ${(i -1)}"
            >
                <span th:text='${i}'>1</span>
            </a>
        </li>
        <li th:class="${page.hasNext()} ? '' : 'disabled'">
            <span th:if='${not page.hasNext()}'>»</span>
            <a
                    th:if='${page.hasNext()}'
                    th:href="'?page=' + ${page.getNumber() + 1}"
                    title='Go to next page'
            >
                »
            </a>
        </li>
        <li th:class="${page.isLast()}? 'disabled' : ''">
            <span th:if='${page.isLast()}'>Last →</span>
            <a
                    th:if='${not page.isLast()}'
                    th:href="'?page=' + ${page.getTotalPages() - 1}"
            >
                Last →
            </a>
        </li>
    </ul>
</nav>

<footer th:include="fragments/footer :: my-footer"></footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<!--<script type="text/javascript" src="js/jquery.ajax-cross-origin.min.js"></script>-->
<script th:inline="javascript">

    $('.replyTextArea').hide(); // hide the reply text area.
    $('.editedCommentForm').hide(); //hide the edit comment form.

    $('.showReplyTextArea').on('click', function () {
        $(this).text(function (_, oldText) {
            return oldText === 'CANCEL' ? 'REPLY' : 'CANCEL';
        });
        $(this).next().toggle(500);
    });

    $('.form').submit(function () {
        $(".replyTextArea").hide();
    });

    <!-- =================================================================================================================-->
    <!-- ============================================== SUBMIT Comment ===================================================-->
    <!-- =================================================================================================================-->

    $('.commentSubmitBtn').on("click", function (e) {
        console.log($('.commentForm').serialize());
        e.preventDefault();

        let request = $.ajax({
            // crossOrigin: true, //XSS shield.
            url: '/posts/' + $("#postId").val(), // @PostMapping("/posts/{postId}") in PostsController
            method: 'POST',
            dataType: 'html', // I'm returning html from the PostsController method postComment()
            // dataType: 'json',
            data: $('.commentForm').serialize()
        });
        request.done((html) => {
        // request.done((comment) => { // no need for confusion here, not returning a comment, but html.

            console.log("==== hello from ajax comment request.done");
            //console.log(comment.id);
            //comment id's will always be undefined here because I'm not returning an object, I'm returning html.

            $('#commentFormBody').val(''); // clear the input field.
            $('#commentsAJAX').prepend(html); //prepend the comment to the top of the div length.
            $('.editedCommentForm').hide(); //hide the reply form.
            $('.replyTextArea').hide(); // hide the reply text area.
        });

        request.fail((a, b, c) => {
            console.log(a, b, c)
        });
    });

    <!-- =================================================================================================================-->
    <!-- ============================================== EDIT Comment =====================================================-->
    <!-- =================================================================================================================-->

    //The edit button is only an event trigger. When I click on the edit button:
    //A new textarea is revealed in place of the comment.body. Textarea should be populated with the original comment text. (controller)
    //When I click on the new submit button, new data should replace the previous data. (controller)

    $('.container').on("click", ".editCommentBtn", function () {
        console.log("edit button clicked");

        let $button = $(this);
        let commentId = $button.data('edit-btn-comment-id');
        console.log("commentid: " + commentId);

        //================================== AJAX ==================================
        let request = $.ajax({
            url: '/posts/' + $("#postId").val() + '/comment/' + commentId + '/edit',
            method: 'GET',
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            data: commentId
        });
        request.done(function (comment) {
            console.log("hello from edited comment request.done");
            console.log(comment.body);

            let $commentBody = $('[data-commentBody-comment-id=' + commentId + ']');
            let $replyButton = $('[data-replyButton-comment-id=' + commentId + ']');
            let $commentForm = $('[data-edit-form-comment-id=' + commentId + ']');

            $commentBody.hide(); // hide the original comment body
            $replyButton.hide(); // hide the reply link
            $commentForm.show(); // I just want to show "this" edit form
            $('.editedCommentBodyText').text(comment.body); // put the text of comment.body inside the newly visible textarea.

            //================= cancel button ====================
            //====================================================

            $('.editedCommentCancelBtn').on("click", function(e) { // on cancel button click...
                e.preventDefault();
                $commentForm.hide(); // hide the edit form
                $commentBody.show(); // show the original comment back in the html
                $replyButton.show(); // show the reply button again
                // $commentBody.show(0, comment.body); this also works. very interesting dom error if you remove the 0.
            })

        });
        request.fail((a, b, c) => {
            console.log(a, b, c)
        });

    });

    <!-- =================================================================================================================-->
    <!-- ============================================ SUBMIT EDITED Comment ==============================================-->
    <!-- =================================================================================================================-->

    $('.container').on("click", ".editedCommentSubmitBtn", function (e) {
        e.preventDefault();

        let $button = $(this);
        let commentId = $button.parent().data('edit-form-comment-id'); // get id
        // let content = $button.parent().children('textarea').text(); // I don't have to grab the content in the form.
        let commentForm = $('[data-edit-form-comment-id=' + commentId + ']'); // because I can just get the form

        let request = $.ajax({
            url: '/posts/' + $("#postId").val() + '/comment/' + commentId + '/edit',
            method: 'POST',
            dataType: 'json',
            data: commentForm.serialize()
            });
        request.done(function (comment) {
            console.log("hello from submitted edited comment request.done");
            console.log("new comment: " + comment.body);

            let $commentBody = $('[data-commentBody-comment-id=' + commentId + ']');
            let $replyButton = $('[data-replyButton-comment-id=' + commentId + ']');
            let $commentForm = $('[data-edit-form-comment-id=' + commentId + ']');

            $commentForm.hide(); // hide the edit form
            $commentBody.show().html(comment.body); // show the new updated comment in the html
            $replyButton.show(); // show the reply button again
        })
    });

    <!-- =================================================================================================================-->
    <!-- ============================================== DELETE Comment  ==================================================-->
    <!-- =================================================================================================================-->

    $('.container').on("click", ".deleteCommentBtn", function (e) {
        // use event delegation that targets an elements parent, something, that isn't dynamic: .container
        e.preventDefault(); // prevent default form behavior and instead use ajax.
        let commentInformation = $(this).parent().serialize();
        console.log(commentInformation);

        let $button = $(this);
        // Look for element with this attribute. We're looking for siblings(other comments) within the container.
        let commentId = $button.siblings('[data-comment-id]').data('comment-id');
        console.log(commentId);

        let request = $.ajax({
            url: '/posts/' + $("#postId").val() + '/comment/' + commentId + '/delete',
            method: 'POST',
            data: commentInformation
            // data: JSON.stringify({id: deleteCommentId}),
        });
        request.done(function () {

            console.log("hello from delete request.done");
            console.log($button);
            $('[data-edit-delete-comment-id=' + commentId + ']').remove(); // new way targets element directly.
            // $button.parent().parent().parent().parent().parent().remove(); // removes from html (old way/bad way)
        });
        request.fail((a, b, c) => {
            console.log(a, b, c)
        });
    })

</script>
</body>
</html>
<!--//inside ajax-->
<!--// let html = '';-->
<!--// html += '<div>';-->
<!--// html += '<p>' + comment.body + '</p>';-->
<!--// // html += '<p>Published by: ' + comment.user.username + '</p>'; //jsonignore user (remove). Ajax isn't doing that much magic. You still need controllers.-->
<!--// html += '</div>';-->
<!--// console.log(html);-->